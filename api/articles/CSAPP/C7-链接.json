{"title":"C7 链接","uid":"a0222f48ea50656458184947f3dd6fed","slug":"CSAPP/C7-链接","date":"2021-09-06T12:10:30.000Z","updated":"2021-09-07T12:27:10.000Z","comments":true,"path":"api/articles/CSAPP/C7-链接.json","keywords":null,"cover":[],"content":"<h1 id=\"链接\"><a href=\"#链接\" class=\"headerlink\" title=\"链接\"></a>链接</h1><h2 id=\"引入\"><a href=\"#引入\" class=\"headerlink\" title=\"引入\"></a>引入</h2><div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>项目</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>链接的定义</td>\n<td>将各种代码和数据片段收集并组合成为一个单一文件的过程，这个文件可被加载(复制)到内存并执行</td>\n</tr>\n<tr>\n<td>执行时间</td>\n<td>compile time/load time/run time</td>\n</tr>\n<tr>\n<td>作用</td>\n<td>使得separate compilation成为可能<br />将模块分解为更小、更好管理的模块</td>\n</tr>\n<tr>\n<td>学习的必要性</td>\n<td>帮助构造大型程序<br />帮助避免危险的编程错误<br />帮助理解语言的作用域规则如何实现<br />帮助理解其他重要的系统概念<br />能够利用共享库</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h2 id=\"编译器驱动程序\"><a href=\"#编译器驱动程序\" class=\"headerlink\" title=\"编译器驱动程序\"></a>编译器驱动程序</h2><p><code>main.c</code></p>\n<pre class=\"line-numbers language-c\" data-language=\"c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>a<span class=\"token punctuation\">,</span><span class=\"token keyword\">int</span> n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> array<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">int</span> val <span class=\"token operator\">=</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>array<span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> val<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><code>sum.c</code></p>\n<pre class=\"line-numbers language-c\" data-language=\"c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>a<span class=\"token punctuation\">,</span><span class=\"token keyword\">int</span> n<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">,</span>s <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>n<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#123;</span>\n    s <span class=\"token operator\">+=</span> a<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">return</span> s<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">gcc -Og -o prog main.c sum.c<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p><img src=\"https://tva1.sinaimg.cn/large/008i3skNgy1gu76m7ac74j61120fcta902.jpg\" alt=\"截屏2021-09-06 下午8.29.53\"></p>\n<h2 id=\"静态链接\"><a href=\"#静态链接\" class=\"headerlink\" title=\"静态链接\"></a>静态链接</h2><pre class=\"mermaid\">graph TD\n可重定位目标文件和命令行参数\n--static.linker--> 完全链接的且可加载和运行的可执行目标文件\n\n不同的代码和数据节组成.每一节都是一个连续的字节序列\n--符号解析.重定位--> 输出</pre>\n\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>任务</th>\n<th>英文</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>符号解析</td>\n<td>symbol resolution</td>\n<td>将每个<strong>符号引用</strong>正好和一个<strong>符号定义</strong>关联起来<br />目标文件<strong>定义和引用</strong>符号<br />每个符号对应于一个函数、一个全局变量或一个静态变量</td>\n</tr>\n<tr>\n<td>重定位</td>\n<td>relocation</td>\n<td>编译器和汇编器生成从地址0开始的代码和数据节<br />链接器通过把每个符号定义与一个内存位置关联起来，从而<strong>重定位</strong>这些节，然后修改所有对这些符号的引用，使得它们指向这个内存位置</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>对于链接器的一些基本事实</p>\n<ul>\n<li>目标文件纯粹是字节块的集合<ul>\n<li>程序代码</li>\n<li>程序数据</li>\n<li>引导链接器和加载器的数据结构</li>\n</ul>\n</li>\n<li>链接器将字节块连接起来，确定被连接块的运行时位置，并且修改代码和数据块中的各种位置</li>\n<li>链接器对目标机器了解甚少</li>\n</ul>\n<h2 id=\"目标文件\"><a href=\"#目标文件\" class=\"headerlink\" title=\"目标文件\"></a>目标文件</h2><p>三种形式</p>\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>类型</th>\n<th>包含</th>\n<th>形式</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>可重定位目标文件</td>\n<td>二进制代码和数据</td>\n<td>可以在编译时与其他可重定位目标文件合并起来，创建一个可执行目标文件</td>\n</tr>\n<tr>\n<td>可执行目标文件</td>\n<td>二进制代码和数据</td>\n<td>可以被直接复制到内存并执行</td>\n</tr>\n<tr>\n<td>共享目标文件</td>\n<td>特殊的可重定位目标文件</td>\n<td>可以在加载或者运行时被动态地加载进内存并链接</td>\n</tr>\n</tbody>\n</table>\n</div>\n<ul>\n<li>object module：字节序列</li>\n<li>object file：一个以文件形式存放在磁盘中的目标模块</li>\n</ul>\n<p>各个系统目标文件格式</p>\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>系统</th>\n<th>目标文件格式</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>贝尔实验室第一个Unix系统</td>\n<td>a.out</td>\n</tr>\n<tr>\n<td>Windows</td>\n<td>PE(Portable Executable)</td>\n</tr>\n<tr>\n<td>Mac-OS-X</td>\n<td>Mach-O</td>\n</tr>\n<tr>\n<td>现代x86-64 Linux和Unix</td>\n<td>ELF(Executable and Linkable Format)</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h2 id=\"可重定位目标文件\"><a href=\"#可重定位目标文件\" class=\"headerlink\" title=\"可重定位目标文件\"></a>可重定位目标文件</h2><p>一个典型的ELF可重定位目标文件的格式</p>\n<p><img src=\"https://tva1.sinaimg.cn/large/008i3skNgy1gu78maan93j61o80m077n02.jpg\" alt=\"截屏2021-09-06 下午9.35.32\"></p>\n<h2 id=\"符号和符号表\"><a href=\"#符号和符号表\" class=\"headerlink\" title=\"符号和符号表\"></a>符号和符号表</h2><p>每个可重定位目标模块m都有一个符号表，包含m定义和引用的符号的信息。在链接器的上下文中，有三种不同的符号</p>\n<div class=\"table-container\">\n<table>\n<thead>\n<tr>\n<th>符号类型</th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>由模块m定义并能够被其他模块引用的全局符号</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>由其他模块定义并被模块m引用的全局符号</td>\n<td>称为外部符号，对应于在其他模块中定义的非静态C函数和全局变量</td>\n<td></td>\n</tr>\n<tr>\n<td>只被模块m定义和引用的局部符号</td>\n<td>对应于带static属性的C函数和全局变量</td>\n</tr>\n</tbody>\n</table>\n</div>\n","text":"链接引入 项目 含义 链接的定义 将各种代码和数据片段收集并组合成为一个单一文件的过程，这个文件可被加载(复制)到内存并执行 执行时间 compile time/load time/run time 作用 使得separate compilation成为可能将模块分解为更小、更好...","link":"","photos":[],"count_time":{"symbolsCount":"1.5k","symbolsTime":"1 mins."},"categories":[{"name":"CSAPP","slug":"CSAPP","count":8,"path":"api/categories/CSAPP.json"}],"tags":[{"name":"CSAPP","slug":"CSAPP","count":8,"path":"api/tags/CSAPP.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E9%93%BE%E6%8E%A5\"><span class=\"toc-text\">链接</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%BC%95%E5%85%A5\"><span class=\"toc-text\">引入</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BC%96%E8%AF%91%E5%99%A8%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F\"><span class=\"toc-text\">编译器驱动程序</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5\"><span class=\"toc-text\">静态链接</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6\"><span class=\"toc-text\">目标文件</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8F%AF%E9%87%8D%E5%AE%9A%E4%BD%8D%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6\"><span class=\"toc-text\">可重定位目标文件</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%AC%A6%E5%8F%B7%E5%92%8C%E7%AC%A6%E5%8F%B7%E8%A1%A8\"><span class=\"toc-text\">符号和符号表</span></a></li></ol></li></ol>","author":{"name":"Rambo","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"Still Water Runs Deep","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Hello World","uid":"b9663f58f18133b35bfe243f3e916a80","slug":"hello-world","date":"2021-10-01T08:36:50.265Z","updated":"2021-10-01T08:36:50.265Z","comments":true,"path":"api/articles/hello-world.json","keywords":null,"cover":null,"text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the ...","link":"","photos":[],"count_time":{"symbolsCount":426,"symbolsTime":"1 mins."},"categories":[],"tags":[],"author":{"name":"Rambo","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"Still Water Runs Deep","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"C6 存储器层次结构","uid":"ef5fe063a7d3aa88da43f1d6119bbac2","slug":"CSAPP/C6-存储器层次结构","date":"2021-09-05T07:45:30.000Z","updated":"2021-09-06T12:09:56.000Z","comments":true,"path":"api/articles/CSAPP/C6-存储器层次结构.json","keywords":null,"cover":null,"text":"存储器层次结构引入存储技术局部性存储器层次结构高速缓存存储器编写高速缓存友好的代码综合：高速缓存对程序性能的影响","link":"","photos":[],"count_time":{"symbolsCount":56,"symbolsTime":"1 mins."},"categories":[{"name":"CSAPP","slug":"CSAPP","count":8,"path":"api/categories/CSAPP.json"}],"tags":[{"name":"CSAPP","slug":"CSAPP","count":8,"path":"api/tags/CSAPP.json"}],"author":{"name":"Rambo","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"Still Water Runs Deep","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}